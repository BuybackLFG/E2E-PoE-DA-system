# E2E-PoE-DA-system

Система сбора и анализа данных Path of Exile с автоматическим заполнением исторических данных.

## Структура ДБ

```
E2E-PoE-DA-system/
├── collector/
│   ├── collector.py              # Главный коллектор (текущие данные)
│   ├── backfill_historical.py     # Скрипт для заполнения исторических данных
│   ├── league_manager.py         # Управление лигами в дб
│   ├── parsers/                  # парсеры
│   │   ├── currency.py           # валют (текущие данные)
│   │   ├── cards.py              # карт гаданий (текущие данные)
│   │   ├── items.py              # уникальных предметов (текущие данные)
│   │   ├── league_finder.py      # поиск последней лиги
│   │   ├── historical.py         # дампы старых лиг (ZIP архивы)
│   │   └── historical_backfill.py # модуль для заполнения исторических данных
│   ├── init-db/
│   │   └── init.sql              # схема дб
│   ├── Dockerfile
│   └── requirements.txt
├── docker-compose.yml
├── .env.example
└── README.md
```

## Используемые ресурсы

- [poe.ninja](https://poe.ninja) - Источник данных экономики PoE
- [poewiki.net](https://www.poewiki.net) - Информация по лигам

## Функциональность

### 1. Сбор текущих данных (collector.py)

Главный коллектор автоматически собирает актуальные данные каждые 30 минут:

- **Валюты** (currency_prices): цены на орбы и валюту
- **Карты гаданий** (divination_cards): цены на карты
- **Уникальные предметы** (unique_items): цены на уникальное оружие

Запуск:
```bash
python collector/collector.py
```

### Автоматический запуск backfill при старте контейнера

Коллектор может автоматически заполнить исторические данные при старте Docker контейнера. Это полезно для заполнения пробелов в данных после первого развертывания или после перерыва в работе.

Для включения автоматического заполнения добавьте в `.env` файл:

```env
RUN_BACKFILL_ON_START=true
```

**Поведение:**
- Заполняет все типы данных (валюты, карты гаданий, уникальные предметы)
- Заполняет данные за последние 90 дней
- Использует последнюю лигу (или SPECIFIC_LEAGUE, если указана)
- Выполняется один раз при старте контейнера
- Не прерывает работу коллектора при ошибках

**Примеры:**

```bash
# Включить автоматический backfill при старте
echo "RUN_BACKFILL_ON_START=true" >> .env

# Запустить контейнер - backfill выполнится автоматически
docker-compose up collector
```

Если `RUN_BACKFILL_ON_START=false` или переменная не указана, автоматическое заполнение отключено.

### 2. Заполнение исторических данных (backfill_historical.py)

Скрипт для заполнения пропусков в исторических данных. Автоматически:

- Находит ID предметов из текущего API poe.ninja
- Сопоставляет их с названиями в вашей базе данных
- Загружает исторические данные за прошедшие дни
- Вычисляет отсутствующие значения (chaos_equivalent, trade_count)
- Пропускает даты, которые уже есть в базе




#### Аргументы командной строки:

- `--league` (обязательно): имя лиги для заполнения (например, Keepers, Settlers)
- `--type`: тип данных для заполнения
  - `currency` - только валюты
  - `divination_cards` - только карты гаданий
  - `unique_items` - только уникальные предметы
  - `all` - все типы (по умолчанию)
- `--days`: максимальное количество дней для поиска назад (по умолчанию: 90)
- `--list-leagues`: показать доступные лиги и выйти

#### Примеры использования:

```bash
# Быстрый запуск для последней лиги (последние 30 дней)
python collector/backfill_historical.py --league Settlers --days 30

# Полное заполнение для всех типов данных
python collector/backfill_historical.py --league Settlers --all --days 90

# Заполнение только валют за неделю
python collector/backfill_historical.py --league Settlers --type currency --days 7
```

### 3. Дампы старых лиг (historical.py)

Для работы с ZIP-архивами исторических дампов poe.ninja.

## Конфигурация

Файл `.env` должен содержать:

```env
DB_USER=your_db_user
DB_PASSWORD=your_db_password
DB_NAME=your_db_name
DB_HOST=db
DB_PORT=5432

# Запустить заполнение исторических данных при старте контейнера (true/false)
RUN_BACKFILL_ON_START=false

# Собирает дампы старых лиг (true/false)
COLLECT_HISTORICAL=false

# Собирает данные только для ОДНОЙ лиги (если пусто, то собирается последняя лига)
# Пример: SPECIFIC_LEAGUE=Settlers
SPECIFIC_LEAGUE=
```

**Переменные конфигурации:**

- `DB_USER`, `DB_PASSWORD`, `DB_NAME`, `DB_HOST`, `DB_PORT` - настройки подключения к базе данных
- `RUN_BACKFILL_ON_START` - автоматически заполнить исторические данные при старте контейнера (true/false)
- `COLLECT_HISTORICAL` - собирать данные из дампов старых лиг (true/false)
- `SPECIFIC_LEAGUE` - собирать данные только для указанной лиги (опционально)

## Интеграция с Docker

Запуск коллектора в контейнере:
```bash
docker-compose up collector
```


### Процесс работы заполнения пропусков:

1. **Получение деталей из текущего API**: Загружает актуальный список предметов с их ID
2. **Сопоставление с базой данных**: Находит соответствия между именами в базе и ID из API
3. **Определение пропусков**: Проверяет, какие даты отсутствуют в базе для каждого предмета
4. **Загрузка исторических данных**: Запрашивает данные с poe.ninja для отсутствующих дат
5. **Обработка и вставка**: Вычисляет недостающие значения и сохраняет в базу

### Логирование

- Информационные сообщения о прогрессе
- Предупреждения о пропущенных данных
- Ошибки с полным стеком вызовов
- Итоговая статистика по каждому типу данных

Логи сохраняются в файл `backfill.log` и выводятся в консоль.

## Важные примечания

1. **Chaos Orb (id=1)** всегда пропускается, так как это базовая валюта для измерения цен
2. **details_id** в исторических данных всегда `NULL`, так как это поле недоступно в историческом API
3. Скрипт автоматически пропускает даты, которые уже есть в базе данных
4. Все вычисления выполняются с учетом особенностей каждого типа данных
5. Скрипт обрабатывает ошибки для каждого предмета индивидуально, продолжая работу при сбоях

